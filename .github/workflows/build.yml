name: AdBlock List Aggregator

# 1. è®¾ç½®è§¦å‘å™¨: æ¯å¤©å®šæ—¶è¿è¡Œä¸€æ¬¡
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
permissions:
  contents: write # æˆäºˆé»˜è®¤ GITHUB_TOKEN å¯¹ä»“åº“å†…å®¹çš„å†™å…¥æƒé™ï¼Œä½¿å…¶å¯ä»¥ push
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      # é»˜è®¤æ£€å‡º main åˆ†æ”¯
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. è®¾ç½® Go ç¯å¢ƒ
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.0' 

      # 3. æ„å»ºå¹¶è¿è¡Œ Go ç¨‹åº
      - name: Build and Run Go Program
        run: |
          go build -o adblock-aggregator main.go
          ./adblock-aggregator
          # è¿è¡Œåå°†ç”Ÿæˆ adblock_aggr_optimized.txt å’Œ adblock_debug_unrecognized.txt æ–‡ä»¶

      # 4. æäº¤æ›´æ”¹åˆ° dist åˆ†æ”¯
      - name: Commit and Push new list to dist branch
        run: |
          # 1. é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          
          # 2. æ£€æŸ¥ dist åˆ†æ”¯æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼ˆå¯é€‰ï¼Œä½†æ›´å¥å£®ï¼‰
          # è¿™ç¡®ä¿äº†å³ä½¿æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œä¹Ÿèƒ½åˆ›å»º dist åˆ†æ”¯
          git fetch origin dist:dist || git checkout --orphan dist
          
          # 3. åˆ‡æ¢åˆ° dist åˆ†æ”¯ï¼ˆå¦‚æœä¸åœ¨ dist ä¸Šï¼Œæˆ–è€…åˆšåˆšåˆ›å»ºï¼‰
          git checkout dist

          # 4. ä» main åˆ†æ”¯å¤åˆ¶æ–‡ä»¶è¿‡æ¥
          # ç¡®ä¿è¿™ä¸¤ä¸ªæ–‡ä»¶æ˜¯æœ€æ–°ç”Ÿæˆçš„
          # å¦‚æœå®ƒä»¬æ˜¯åœ¨å·¥ä½œåŒºç”Ÿæˆçš„ï¼Œå¯ä»¥ç›´æ¥æ·»åŠ ã€‚
          # å‡è®¾å®ƒä»¬ç”Ÿæˆåœ¨å·¥ä½œåŒºçš„æ ¹ç›®å½•ä¸‹ï¼š
          git add -f adblock_aggr_optimized.txt adblock_debug_unrecognized.txt
          
          # 5. æ£€æŸ¥æ˜¯å¦æœ‰å®é™…çš„æ›´æ”¹ï¼ˆé˜²æ­¢ç©ºæäº¤ï¼‰
          if ! git diff --cached --exit-code --quiet; then
              echo "å‘ç°æ–°åˆ—è¡¨å­˜åœ¨æ›´æ”¹ï¼Œå¼€å§‹æäº¤åˆ° dist åˆ†æ”¯..."
              
              # 6. æäº¤æ›´æ”¹
              git commit -m "ğŸ¤– Feat: Update aggregated adblock list (Daily Run)"
              
              # 7. æ¨é€æ›´æ”¹åˆ° GitHub çš„ dist åˆ†æ”¯
              # æ˜ç¡®æŒ‡å®šæ¨é€ç›®æ ‡åˆ†æ”¯ä¸º dist
              git push origin dist
          else
              echo "æ–‡ä»¶å†…å®¹ä¸ä¸Šæ¬¡æäº¤åˆ° dist åˆ†æ”¯çš„å†…å®¹ç›¸åŒï¼Œè·³è¿‡æäº¤ã€‚"
          fi