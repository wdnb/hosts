name: AdBlock List Aggregator

# 1. è®¾ç½®è§¦å‘å™¨: æ¯å¤©å®šæ—¶è¿è¡Œä¸€æ¬¡
on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 06:00
    - cron: '0 22 * * *'
  workflow_dispatch:

permissions:
  contents: write # æˆäºˆé»˜è®¤ GITHUB_TOKEN å¯¹ä»“åº“å†…å®¹çš„å†™å…¥æƒé™ï¼Œä½¿å…¶å¯ä»¥ push

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v6

      # 2. è®¾ç½® Go ç¯å¢ƒ
      - name: âš™ï¸ Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: 'stable' 
      
      # --- â¬‡ï¸ å…³é”®æ–°å¢æ­¥éª¤ï¼šä¸‹è½½ VPS æ–‡ä»¶ â¬‡ï¸ ---
      - name: ğŸ” Set up SSH Private Key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          # ä» Secret ä¸­åŠ è½½ç§é’¥ï¼Œç”¨äºè¿æ¥ VPS
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: â¬‡ï¸ Download invalid_domains.txt via SCP
        # å°†æ–‡ä»¶ä¸‹è½½åˆ°å½“å‰å·¥ä½œç›®å½•ï¼Œä»¥ä¾¿ Go ç¨‹åºå¯ä»¥è¯»å–
        run: |
          # ä¸‹è½½åˆ° Action è¿è¡Œæ—¶ï¼š./invalid_domains.txt
          scp -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:/home/${{ secrets.VPS_USERNAME }}/hosts_repo/invalid_domains.txt \
            ./invalid_domains.txt
      # --- â¬†ï¸ å…³é”®æ–°å¢æ­¥éª¤ï¼šä¸‹è½½ VPS æ–‡ä»¶ â¬†ï¸ ---

      # 3. æ„å»ºå¹¶è¿è¡Œ Go ç¨‹åº
      - name: ğŸš€ Build and Run Go Program
        run: |
          # ç¡®ä¿æ‚¨çš„ Go ç¨‹åºèƒ½å¤Ÿè¯»å–å½“å‰ç›®å½•ä¸‹çš„ invalid_domains.txt æ–‡ä»¶
          go build -o adblock-aggregator main.go
          ./adblock-aggregator
          # è¿è¡Œåå°†ç”Ÿæˆ adblock_lite.txt ç­‰æ–‡ä»¶

      # 4. æäº¤æ›´æ”¹å›ä»“åº“
      - name: ğŸ“¤ Commit and Push new list
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          
          # æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ç¡®ä¿æ‚¨çš„ Go ç¨‹åºä¸å†éœ€è¦çš„æ—§æ–‡ä»¶å
          git add -f adblock_lite.txt adblock_debug.txt adaway_hosts.txt
          
          if ! git diff --cached --exit-code --quiet; then
              echo "å‘ç° adblock åˆ—è¡¨å­˜åœ¨æ›´æ”¹ï¼Œå¼€å§‹æäº¤..."
              git commit -m "ğŸ¤– Feat: Update aggregated adblock list (Daily Run)"
              git push https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          else
              echo "æ–‡ä»¶å†…å®¹ä¸ä¸Šæ¬¡æäº¤ç›¸åŒï¼Œè·³è¿‡æäº¤ã€‚"
          fi